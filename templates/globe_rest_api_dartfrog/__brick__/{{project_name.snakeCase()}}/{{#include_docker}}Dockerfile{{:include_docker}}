# Use the official Dart image from the Docker Hub for the build environment
FROM dart:stable AS build

# Set the working directory inside the container
WORKDIR /app

# Copy the pubspec files and resolve dependencies separately to improve caching
COPY pubspec.* ./
RUN dart pub get

# Copy the rest of the project files into the container
COPY . .

# Run the Dart Frog build command to generate the application
RUN dart pub global activate dart_frog_cli
RUN dart pub global run dart_frog build

# Compile the generated Dart Frog application to a standalone executable
RUN dart compile exe bin/server.dart -o bin/server

# Build the production image from the scratch image
FROM scratch
COPY --from=build /runtime/ /
COPY --from=build /app/bin/server /app/bin/

# Expose the port that your app serves on
EXPOSE 8080

# Run the server executable
CMD ["/app/bin/server"]
